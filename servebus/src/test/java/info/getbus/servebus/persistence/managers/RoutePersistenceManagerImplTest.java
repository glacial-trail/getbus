package info.getbus.servebus.persistence.managers;import info.getbus.servebus.persistence.LockedRouteException;import info.getbus.servebus.persistence.datamappers.route.RouteAwareBaseTest;import info.getbus.servebus.persistence.datamappers.route.RouteMapper;import info.getbus.servebus.persistence.datamappers.route.RoutePointMapper;import org.junit.Test;import org.junit.runner.RunWith;import org.mockito.InOrder;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.Spy;import org.mockito.junit.MockitoJUnitRunner;import static org.junit.jupiter.api.Assertions.assertThrows;import static org.mockito.ArgumentMatchers.eq;import static org.mockito.Mockito.inOrder;import static org.mockito.Mockito.times;import static org.mockito.Mockito.verify;import static org.mockito.Mockito.verifyNoMoreInteractions;import static org.mockito.Mockito.when;@RunWith(MockitoJUnitRunner.class)public class RoutePersistenceManagerImplTest extends RouteAwareBaseTest {    @Mock    private    RouteMapper routeMapper;    @Mock    private    RoutePointMapper pointMapper;    @InjectMocks    @Spy    private    RoutePersistenceManagerImpl pm;    @Test    public void createRoute() throws Exception {        long transporterAreaId = 44;        user.setTransporterAreaId(transporterAreaId);        pm.createRoute(route, user, true);        InOrder inOrder = inOrder(routeMapper, pm);        inOrder.verify(routeMapper).insertLocked(eq(transporterAreaId), eq(route), eq(user.getUsername()));        verifyNoMoreInteractions(routeMapper);        inOrder.verify(pm, times(1)).savePoints(eq(route));    }    @Test    public void tryToLockFor() throws Exception {        when(routeMapper.selectLockOwnerForUpdate(1L)).thenReturn("11");        pm.tryLockFor(1L, "11");        verify(routeMapper).selectLockOwnerForUpdate(eq(1L));        verifyNoMoreInteractions(routeMapper);    }    @Test    public void tryToLockFor_null() throws Exception {        when(routeMapper.selectLockOwnerForUpdate(1L)).thenReturn(null);        pm.tryLockFor(1L, "11");        InOrder inOrder = inOrder(routeMapper);        inOrder.verify(routeMapper).selectLockOwnerForUpdate(eq(1L));        inOrder.verify(routeMapper).updateLockOwner(eq(1L), eq("11"));        verifyNoMoreInteractions(routeMapper);    }    @Test    public void tryToLockFor_oth() throws Exception {        when(routeMapper.selectLockOwnerForUpdate(1L)).thenReturn("22");        assertThrows(LockedRouteException.class, () -> pm.tryLockFor(1L, "11"));        verify(routeMapper).selectLockOwnerForUpdate(eq(1L));        verifyNoMoreInteractions(routeMapper);    }    @Test    public void checkLock() throws Exception {        when(routeMapper.selectLockOwner(1L)).thenReturn("11");        pm.checkLock(1L, "11");        verify(routeMapper).selectLockOwner(1L);        verifyNoMoreInteractions(routeMapper);    }    @Test    public void checkLock_null() throws Exception {        when(routeMapper.selectLockOwner(1L)).thenReturn(null);        assertThrows(LockedRouteException.class, () -> pm.checkLock(1L, "11"));        verify(routeMapper).selectLockOwner(eq(1L));        verifyNoMoreInteractions(routeMapper);    }    @Test    public void checkLock_other() throws Exception {        when(routeMapper.selectLockOwner(1L)).thenReturn("22");        assertThrows(LockedRouteException.class, () -> pm.checkLock(1L, "11"));        verify(routeMapper).selectLockOwner(eq(1L));        verifyNoMoreInteractions(routeMapper);    }}