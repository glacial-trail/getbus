<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="info.getbus.servebus.dao.security.UserMapper">

    <resultMap id="userMap" type="User">
        <constructor>
            <idArg column="username" javaType="string"/>
            <arg column="password" javaType="string"/>
            <arg column="enabled" javaType="_boolean"/>
            <arg column="firstname" javaType="string"/>
            <arg column="lastname" javaType="string"/>
            <arg column="phone" javaType="string"/>
        </constructor>
        <result column="transporter_id" property="transporterAreaId" />
        <collection property="authorities" ofType="org.springframework.security.core.authority.SimpleGrantedAuthority">
            <constructor>
                <arg column="authority" javaType="string"/>
            </constructor>
        </collection>
    </resultMap>


    <sql id="simpleSelect">
      SELECT
        u.*,
        u2t.transporter_id,
        a.authority
      FROM users u
      LEFT JOIN authorities a ON u.username = a.username
      LEFT JOIN user2transporter u2t ON u.username = u2t.username
    </sql>

    <select id="selectById" resultMap="userMap">
        <include refid="simpleSelect"/>
        WHERE u.username = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="false">
        INSERT INTO users(username, password, enabled, firstname, lastname, phone) VALUES
            (#{username}, #{password}, #{enabled}, #{firstname}, #{lastname}, #{phone})
    </insert>

    <insert id="insertRoles" useGeneratedKeys="false">
        INSERT INTO authorities (username, authority) VALUES
        <foreach item="role" collection="roles" separator=",">
            ( #{username} , #{role.authority} )
        </foreach>
    </insert>

    <select id="selectByUsernameOrPhone" resultMap="userMap">
        <include refid="simpleSelect"/>
        WHERE u.username = #{username} OR u.phone = #{phone}
    </select>

</mapper>